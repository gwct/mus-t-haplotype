---
title: "Mus chr17 inversions"
author: "[gwct](https://gwct.github.io/)"
date: "`r format(Sys.time(), '%m/%d/%Y %H:%M:%S %Z')`"
output:
  #html_document:
  rmdformats::robobook:
    highlight: kate
    includes:
      in_header: '../html-chunks/rmd_header.html'
    df_print: paged
    code_folding: hide
    number_sections: true
    toc_depth: 3
---

```{r setup, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

#library(ggplot2)
library(tidyverse)
library(cowplot)
library(egg)
library(kableExtra)
library(zoo)
library(ggbeeswarm)
library(ggsignif)
library(here)
library("ggtree")
library(eulerr)
library(car)
library(FSA)
library(ggpubr)
source(here("docs", "scripts", "lib", "design.r"))

total_spec = 6

window_size = 10
# Window size in kb

max_tree_rank = 3

```

# Introduction

A closer look at some of the inversions:

```{r calc-div, out.width="50%", fig.align = "center", warning=FALSE}

calcDivStats <- function(d_file, pair_label){
  
  return(read_csv(
      d_file, col_names=c("window", "aln.len", "pair.diffs", "x.out", "y.out")) %>%
        mutate(window = gsub(".filter.fa", "", window)) %>%
        mutate(a.pair = pair.diffs / aln.len) %>%
        mutate(d.pair.jc = -(3/4) * (log(1 - ((4/3) * a.pair)))) %>%
        mutate(d.pair.jc = ifelse(d.pair.jc == Inf, NA, d.pair.jc)) %>%
        mutate(a.out.x = x.out / aln.len) %>%
        mutate(d.out.x.jc = -(3/4) * (log(1 - ((4/3) * a.out.x)))) %>%
        mutate(a.out.y = y.out / aln.len) %>%
        mutate(d.out.y.jc = -(3/4) * (log(1 - ((4/3) * a.out.y)))) %>%
        mutate(a.out = (a.out.x + a.out.y) / 2) %>%
        mutate(d.out.jc = (d.out.x.jc + d.out.y.jc) / 2) %>%
        #mutate(d.out.jc = ifelse(is.nan(d.out.jc), NA, d.out.jc)) %>%
        mutate(rnd = a.pair / a.out) %>%
        mutate(rnd.log = log10(rnd)) %>%
        mutate(rnd.jc = d.pair.jc / d.out.jc) %>%
        mutate(rnd.jc.log = log10(rnd.jc)) %>%
        #mutate(rnd.jc.log = ifelse(is.nan(rnd.jc.log), NA, rnd.jc.log)) %>%
        mutate(label = pair_label)
  )
  
}


```


```{r read-windows, out.width="50%", fig.align = "center", warning=FALSE}

aln_stats_file = here("data", paste0("mm10-", window_size, "kb-window-stats-no-pahari.tsv"))
aln_stats = read.csv(aln_stats_file, header=T, comment.char="#", sep="\t")
aln_stats$window <- gsub('.noanc', '', aln_stats$window)
# Window alignment stats

##########

infile = here("data", paste0("mm10-", window_size, "kb-topo-counts-no-pahari.csv"))
all_windows = read.csv(infile, header=T, comment.char="#")
all_windows = all_windows[order(-all_windows$end), ]
# Window trees file

##########

inversions_file = here("data", "inversions.bed")
inversions = read_tsv(inversions_file, col_names=c("chr", "start", "end", "id"))
inversions$length = inversions$end - inversions$start
inversions$num.windows = inversions$length / (window_size * 1000)

inversions %>%
  kable() %>% 
  kable_styling(bootstrap_options=c("striped", "condended", "responsive"), full_width=F, position="center", fixed_thead=T)
# Inversions

##########

dists_file = here("data", "coord-query-no-pahari", "inv-bps-5-Mb.bed.chr17.dists.all")
dists = read_csv(dists_file)
dists$label = NA
if(!is.na(dists$filt)){
  dists$label = ifelse(dists$rf.st == 0, "Same", "Diff")
}
# Tree dists

##########

intersects_file = here("data", "mm10-10kb-windows-inversions.intersect")
intersects = read_tsv(intersects_file, col_names=c("chr", "start", "end", "window", "inv.chr", "inv.start", "inv.end", "inv.overlap", "inv.overlap.bp"))
intersects = intersects %>% filter(inv.overlap.bp > 1) %>% select(window, inv.overlap, inv.overlap.bp)
# Read the windows with inversion intersects labeled

##########

all_windows = left_join(all_windows, intersects, by="window")
all_windows_f = subset(all_windows, filter=="PASS")
dists = left_join(dists, intersects, by="window")
# Add the inversion intersects to the windows and dists dfs

##########

mm_t_sites_file = here("data", "rnd", "sister", "mm10-mus-t.csv")
mm_t_sites = calcDivStats(mm_t_sites_file, "mm10-mus-t")
mm_t_sites = right_join(mm_t_sites, all_windows, by="window") %>% mutate(label="mm10-mus-t")
mm_t_quant = quantile(mm_t_sites$rnd.jc, probs=c(0.05), na.rm=T)

spi_spr_sites_file = here("data", "rnd", "sister", "spicilegus-spretus.csv")
spi_spr_sites = calcDivStats(spi_spr_sites_file, "spicilegus-spretus")
spi_spr_sites = right_join(spi_spr_sites, all_windows, by="window") %>% mutate(label="spicilegus-spretus")
spi_spr_quant = quantile(spi_spr_sites$rnd.jc, probs=c(0.05), na.rm=T)

mm_spi_sites_file = here("data", "rnd", "non-sister", "mm10-spicilegus.csv")
mm_spi_sites = calcDivStats(mm_spi_sites_file, "mm10-spicilegus")
mm_spi_sites = right_join(mm_spi_sites, all_windows, by="window") %>% mutate(label="mm10-spicilegus")
mm_spi_quant = quantile(mm_spi_sites$rnd.jc, probs=c(0.05), na.rm=T)

t_spi_sites_file = here("data", "rnd", "non-sister", "mus-t-spicilegus.csv")
t_spi_sites = calcDivStats(t_spi_sites_file, "mus-t-spicilegus")
t_spi_sites = right_join(t_spi_sites, all_windows, by="window") %>% mutate(label="mus-t-spicilegus")
t_spi_quant = quantile(t_spi_sites$rnd.jc, probs=c(0.05), na.rm=T)

mm_spr_sites_file = here("data", "rnd", "non-sister", "mm10-spretus.csv")
mm_spr_sites = calcDivStats(mm_spr_sites_file, "mm10-spretus")
mm_spr_sites = right_join(mm_spr_sites, all_windows, by="window") %>% mutate(label="mm10-spretus")
mm_spr_quant = quantile(mm_spr_sites$rnd.jc, probs=c(0.05), na.rm=T)

t_spr_sites_file = here("data", "rnd", "non-sister", "mus-t-spretus.csv")
t_spr_sites = calcDivStats(t_spr_sites_file, "mus-t-spretus")
t_spr_sites = right_join(t_spr_sites, all_windows, by="window") %>% mutate(label="mus-t-spretus")
t_spr_quant = quantile(t_spr_sites$rnd.jc, probs=c(0.05), na.rm=T)

sites_by_windows = bind_rows(mm_t_sites, mm_spi_sites, mm_spr_sites, t_spi_sites, t_spr_sites, spi_spr_sites)
sites_by_windows = sites_by_windows %>% 
  arrange(start) %>%
  group_by(label)
all_quant = quantile(sites_by_windows$rnd.jc, probs=c(0.05), na.rm=T)

#sites_by_windows = right_join(all_sites, all_windows, by="window")

##########

# recomb_file = here("data", "Revised_HSmap_SNPs-mm10-1mb-rates.csv")
# recomb = read_csv(recomb_file) %>% 
#   filter(chr == "17") %>%
#   group_by(window) %>%
#   summarize(rate=slope, start=win.start)

```


```{r topo-counts, out.width="50%", fig.align = "center", warning=FALSE}

topo_counts = unique(subset(all_windows_f, select=c(topo.num.overall, topo.count.overall, topo.rank.overall, topo.color)))
topo_counts = topo_counts[order(topo_counts$topo.rank.overall),]
num_topos = nrow(topo_counts)
# Get the topology counts

#print(paste0("In total ", num_topos, " different topologies were recovered"))
# Display some info

col_rank = 1
for(i in 1:nrow(topo_counts)){
  row = topo_counts[i,]
  cur_col = row$topo.color
  if(cur_col != "#999999"){
    new_label = paste("Top ", col_rank, sep="")
    col_rank = col_rank + 1
  }else{
    new_label = "Other"
  }
  topo_counts$col.cat[topo_counts$topo.num.overall==i] = new_label
  
  if(row$topo.rank.overall > max_tree_rank){
    topo_counts[i,]$topo.color = "#333333"
  }
}
# Add label and color columns to the topo counts

topo_counts$outline = "transparent"
# Add an outline column -- black outline is chrome topo

topo_counts$topo.prop = round(topo_counts$topo.count / sum(topo_counts$topo.count), 2)
# Percentage for each topology.

```


```{r gen-chromoplot, out.width="65%", fig.align = "center", warning=FALSE, fig.height=4}

genChromoPlot <- function(chrome_str, label, features=FALSE, cur_feature=FALSE, num_flank_windows=0, multi_row=TRUE){
# chrome_str:       the chromosome to be subset
# label:            a title, not currently used
# features:         a set of coordinates to be marked on the chromoplot
# cur_feature:      if a single feature is provided here, the chromoplot will be subset to show just that region
# num_flank_window: the number of windows surrounding a feature to subset; to be used with cur_feature, otherwise ignored
# multi_row:        whether or not to display the top three topologies in separate rows on the chromoplot
  
  if(!cur_feature==FALSE){
    flank = num_flank_windows * window_size * 1000
    chrdata = subset(all_windows, chr==chrome_str & start > cur_feature$start - flank & end < cur_feature$end + flank)
  }else{
    chrdata = subset(all_windows, chr==chrome_str)
  }
  # Subset the data by chromosome and feature (if provided)
  
  ##########
  
  chr_len = chrdata[chrdata$chr==chrome_str, ]$chr.len[1]
  # Get the chromosome length
  
  chrdata$col.cat = NA
  chrdata$ystart = NA
  chrdata$yend = NA
  # Initialize some empty columns in the data
  
  cur_col = "#ffffff"
  topo_counts$topo.color = as.character(topo_counts$topo.color)
  # Other setup
  
  for(i in 1:nrow(chrdata)) {
    cur_topo_num = chrdata[i,]$topo.num.overall
    # Get the topology number/id of the current window
    
    if(aln_stats[aln_stats$window == chrdata[i,]$window,]$total.seqs.filter != 5){
      cur_col = "#999999"
      chrdata[i,]$ystart = 0
      chrdata[i,]$yend = 4
    # If this window was filtered out in the alignment steps, set the color to grey and the y coords to span the chromoplot (0 to 4)
    }else if(is.na(cur_topo_num)){
      cur_col = "#999999"
      chrdata[i,]$ystart = 0
      chrdata[i,]$yend = 4
    # If this window was filtered out otherwise, set the color to grey and the y coords to span the chromoplot (0 to 4)
    }else{
      cur_col = topo_counts$topo.color[topo_counts$topo.num.overall==cur_topo_num]
    # If this window was not filtered, set the current color to be the one for the rank by frequency
    }
    
    chrdata[i,]$col.cat = cur_col
    # Set the color for this window based on above
  }
  ## Categorize the windows and get their colors
  
  ##########
  
  if(multi_row){
    chrdata$ystart[chrdata$topo.rank.overall==1] = 4
    chrdata$yend[chrdata$topo.rank.overall==1] = 3
    
    chrdata$ystart[chrdata$topo.rank.overall==2] = 3
    chrdata$yend[chrdata$topo.rank.overall==2] = 2
    
    chrdata$ystart[chrdata$topo.rank.overall==3] = 2
    chrdata$yend[chrdata$topo.rank.overall==3] = 1
    
    chrdata$ystart[chrdata$topo.rank.overall>3] = 1
    chrdata$yend[chrdata$topo.rank.overall>3] = 0
  # If the plot is multi-line, topologies of rank 1, 2, and 3 get their own rows
  }else{
    chrdata$ystart = 1
    chrdata$yend = 0
  # If the plot is not multi-line, all columns go from 0 to 1
  }
  ## Set the y coordinates for the chromoplot
  
  ##########
  
  cols_labs = levels(as.factor(chrdata$col.cat))
  names(cols_labs) = levels(as.factor(chrdata$col.cat))
  # Set up the colors
  
  cur_len = max(chrdata$end) - min(chrdata$start)
  chr_breaks = seq(min(chrdata$start), max(chrdata$end), by=cur_len/5)
  # Set up the x-axis breaks
  
  chromoplot = ggplot(chrdata, aes(x=start, y=ystart, color=col.cat, fill=col.cat))
  
  if(!features==FALSE){
    offset = 3
    feature_cols = corecol(numcol=nrow(features), offset=offset)
    chromoplot = chromoplot +
      geom_rect(data=features, inherit.aes=F, aes(ymin=-Inf, ymax=Inf, xmin=start, xmax=end), alpha=0.2, fill=feature_cols) 
  }
    
  chromoplot = chromoplot + 
    geom_rect(aes(ymin=ystart, ymax=yend, xmin=start, xmax=end)) +
    scale_color_manual(values=cols_labs) +
    scale_fill_manual(values=cols_labs) +
    scale_x_continuous(limits=c(min(chrdata$start), max(chrdata$end)), breaks=chr_breaks) +
    xlab("Position") +
    bartheme() +
    theme(legend.position="none",
          legend.key.width = unit(0.75,  unit = "cm"),
          legend.spacing.x = unit(0.25, 'cm'),
          legend.title = element_blank(),
          #legend.text=element_text(size=12),
          axis.text=element_text(size=8),
          axis.title=element_text(size=10),
          axis.line.y=element_line(color="white"),
          axis.ticks.y=element_line(color="white"),
          axis.text.y=element_text(color="white"),
          axis.title.y=element_text(angle=0),
          plot.margin = unit(c(0,0,0,0), "cm")
  )

  if(!features==FALSE){
    offset = 3
    for(i in 1:nrow(features)){
      chromoplot = chromoplot +
        geom_vline(xintercept=features[i,]$start, color=corecol(numcol=1, offset=offset), size=1) +
        geom_vline(xintercept=features[i,]$end, color=corecol(numcol=1, offset=offset), size=1)
      offset = offset + 1
    }
  }
  # If a set of features have been provided to be marked, draw vertical lines at their boundaries here
  
  if(multi_row){
    chromoplot = chromoplot + 
      scale_y_continuous(limits=c(0,4), breaks=0.5:3.5, labels=c("0.0", "3", "2", "1")) +
      ylab("Topology")
  }else{
    chromoplot = chromoplot + 
      scale_y_continuous(limits=c(0,1), breaks=0.5:1.5, labels=c("0.0", "")) +
      ylab("Topology")
  }
  # Set up the y-axis based on whether the plot is multi-line or not
  
  return(chromoplot)
  # Return the plot
}


```


```{r gen-rfplot, out.width="85%", fig.align = "center", warning=FALSE}

genRFPlot <- function(df, yvar, chrome_str, label, ylab, type="point", ymax=FALSE, quantline=FALSE, groups=FALSE, features=FALSE, cur_feature=FALSE, num_flank_windows=0, num_roll_windows=1){
# chrome_str:       the chromosome to be subset
# label:            a title, not currently used
# features:         a set of coordinates to be marked on the chromoplot
# cur_feature:      if a single feature is provided here, the chromoplot will be subset to show just that region
# num_flank_window: the number of windows surrounding a feature to subset; to be used with cur_feature, otherwise ignored
  
  chrdata = df %>%
    filter(chr == chrome_str)
  
  if(!cur_feature==FALSE){
    flank = num_flank_windows * window_size * 1000
    chrdata = chrdata %>%
      filter(start > cur_feature$start - flank & end < cur_feature$end + flank)
  }
  # Subset the data by chromosome and feature (if provided)
  
  chrdata = chrdata %>%
    arrange(start)
  
  if(!groups==FALSE){
    chrdata = chrdata %>%
      group_by(!!groups)
  }
  
  if(type=="roll"){
    chrdata = chrdata %>%
    mutate(!!yvar := rollapply(!! rlang::sym(yvar), width=num_roll_windows, FUN=function(x) mean(x, na.rm=TRUE), partial=F, fill=NA, align="left"))
  }
  
  ##########
  
  #qts = quantile(chrdata$wrf.st, probs=c(.05,.95), na.rm=T)
  # Calculate some percentiles (not currently used)
  
  cols = rev(c(corecol(pal="wilke", numcol=4, offset=4)))
  # Set up the colors (not currently used)

  cur_len = max(chrdata$end) - min(chrdata$start)
  chr_breaks = seq(min(chrdata$start), max(chrdata$end), by=cur_len/5)
  # Set up the x-axis breaks
  
  if(!groups==FALSE){
    wrf_adj = ggplot(chrdata, aes_string(x="start", y=yvar, color=groups)) +
      scale_color_manual(values=corecol(pal="wilke", numcol=length(unique(chrdata[[groups]]))))
  }else{
    wrf_adj = ggplot(chrdata, aes_string(x="start", y=yvar))
  }
  
  if(!features==FALSE){
    offset = 3
    feature_cols = corecol(numcol=nrow(features), offset=offset)
    wrf_adj = wrf_adj +
      geom_rect(data=features, inherit.aes=F, aes(ymin=0, ymax=Inf, xmin=start, xmax=end), alpha=0.1, fill=feature_cols)
  }
  
  if(type=="point"){
    wrf_adj = wrf_adj +
      geom_point(size=1, alpha=0.1)
      #geom_smooth(se=F)
  }else if(type == "line"){
    wrf_adj = wrf_adj +
      geom_line()    
  }else if(type == "roll"){
    wrf_adj = wrf_adj +
      #geom_line(aes(y=rollapply(chrdata[[yvar]], width=num_roll_windows, FUN=function(x) mean(x, na.rm=TRUE), partial=F, fill=NA, align="left")))
      geom_line()
  }else if(type == "smooth"){
    wrf_adj = wrf_adj +
      geom_smooth(se=F)
  }
  

  if(!quantline==FALSE){
    wrf_adj = wrf_adj +
      geom_hline(yintercept=quantline, size=0.75, linetype="dashed", color="#f0e442")
  }
  
  if(!ymax==FALSE){
    if(ymax=="logy"){
      wrf_adj = wrf_adj +
        scale_y_log10()
    }else{
      wrf_adj = wrf_adj +
        scale_y_continuous(limits=c(0, ymax))
    }
  }

  wrf_adj = wrf_adj +
    scale_x_continuous(limits=c(min(chrdata$start), max(chrdata$end)), breaks=chr_breaks) +
    xlab(NULL) +
    ylab(ylab) +
    bartheme() +
    #theme_classic() +
    theme(axis.text=element_text(size=8),
          axis.title=element_text(size=10),
          #axis.line.x=element_blank(),
          axis.ticks.x=element_blank(),
          axis.title.x=element_blank(),
          axis.text.x=element_blank(),
          axis.title.y=element_text(angle=0),
          plot.margin = grid::unit(c(0,0,0,0), "cm"),
          axis.ticks.length.x = unit(2, "pt"),
          legend.position="bottom")
          #plot.background = element_rect(color = "deepskyblue3", linewidth = 3))
    
  if(!features==FALSE){
    offset = 3
    for(i in 1:nrow(features)){
      wrf_adj = wrf_adj +
        geom_vline(xintercept=features[i,]$start, color=corecol(numcol=1, offset=offset), size=1) +
        geom_vline(xintercept=features[i,]$end, color=corecol(numcol=1, offset=offset), size=1)
      offset = offset + 1
    }
  }
  # If a set of features have been provided to be marked, draw v lines at their boundaries here
  
  leg = get_legend(wrf_adj)
  
  wrf_adj = wrf_adj + 
    theme(legend.position = "none")
  
  return(list(wrf_adj, leg))
  # Return the plot
}

```

In the plots below, I show several statistics on 10kb windows along mm10 chromosome 17 and outline the boundaries of the inversions. I show:

1. For two branches, the divergence of each pair of sequences, $d$ (or $d_{XY}$), under a simple Jukes-Cantor model of nucleotide substitution. Given that for any pair of sequences: $$ p = \frac{n_d}{n} $$ where $n_d$ is the number of sites where the nucleotides differ between the two sequences and $n$ is the total number of aligned (non-gap) sites between the two sequences. Then: $$ d_{XY} = -\frac{3}{4} \ln(1 - \frac{4}{3}p) $$.  Each line represents the rolling mean for one comparison between a pair of species. Note that $d_{XY}$ calculated in this way CAN be larger than 1, but I have capped the plots at 1 since most values fall between 0 and 1.

2. Relative Node Depth ($RND$) for the specified pair of sequences. This statistic uses $d$ between a pair of species, $d_{XY}$, and compares it to the average $d$ from each species to an outgroup, $d_{out}$. $d_{XY}$ is calculated as above, while $d_{XO}$ and $d_{YO}$ are calculated the same way, but between species $X$ and the outgroup, $O$, and species $Y$ and $O$. Then, $$ d_{out} = \frac{d_{XO} +d_{YO}}{2} $$ and $$ RND = \frac{d_{XY}}{d_{out}} $$ LOWER values of $RND$ can be indicative of introgression. See [Rosenzweig et al. 2016](https://hahnlab.sitehost.iu.edu/Publications/Rosenzweig_etal2016.pdf) for more info. Each line represents one comparisong between a pair of species.

3. Weighted Robinson-Foulds (wRF) distance between each window tree and the SPECIES TREE. I gave a brief explanation of wRF [here](https://gwct.github.io/mus-t-haplotype/trees_no_pahari.html#tree-similarity-in-windows-around-inversion-breakpoints). In this case, the REFERENCE TREE is ALWAYS the SPECIES TREE and the QUERY TREE is the tree inferred from that 10kb window. Each dot represents the wRF for one 10kb window.

4. The chromoplot visualizing topological differences in window trees. The colors are the same as [here](https://gwct.github.io/mus-t-haplotype/trees_no_pahari.html#distribution-of-tree-topologies).

The $RND$ values are log10 scaled.

For each panel, vertical shaded regions represent the locations of the inversions.

# Chromosome 17

Rolling mean using a sliding window of 100 10kb windows for $d$ and $RND$ (1Mb with 10kb step).

```{r combine, out.width="75%", fig.align = "center", warning=FALSE, fig.height=4}

sites_by_windows = sites_by_windows %>%
  mutate(roll.d.pair.jc = rollapply(d.pair.jc, width=100, FUN=function(x) mean(x, na.rm=TRUE), partial=T, fill=NA, align="left")) %>%
  mutate(roll.rnd.jc = rollapply(rnd.jc, width=100, FUN=function(x) mean(x, na.rm=TRUE), partial=T, fill=NA, align="left"))

#####

cur_chromoplot = genChromoPlot("chr17", "Chromosome 17", features=inversions)

#####

cur_rfplot = genRFPlot(dists, "wrf.st", "chr17", "Chromosome 17", "wRF to\nspecies tree", ymax=0.5, features=inversions)

#####

cur_d_plot = genRFPlot(sites_by_windows, "roll.d.pair.jc", "chr17", "Inversion 1", ymax=1.0, expression(italic("d")), type="line", groups="label", features=inversions)

cur_rnd_plot = genRFPlot(sites_by_windows, "roll.rnd.jc", "chr17", "Inversion 1", "log(RND)", type="line", ymax="logy", groups="label", features=inversions)

p_main = plot_grid(cur_d_plot[[1]], cur_rnd_plot[[1]], cur_rfplot[[1]], cur_chromoplot, nrow=4, align="v", rel_heights=c(1,1,1,1,1,2))
#print(p_main)
p = plot_grid(p_main, cur_d_plot[[2]], nrow=2, rel_heights=c(1,0.2))
print(p)

###############

# mm_t_d_plot = genRFPlot(left_join(all_windows, mm_t_sites, by="window"), "d.pair.jc", "chr17", "Chromosome 17", expression(paste("mm10-mus-t ", italic("d"))), 1.0, features=inversions)
# 
# mm_t_rnd_plot = genRFPlot(left_join(all_windows, mm_t_sites, by="window"), "rnd.jc", "chr17", "Chromosome 17", "mm10-mus-t\nlog(RND)",  "logy", mm_t_quant, features=inversions)
# 
# #####
# 
# spi_spr_d_plot = genRFPlot(left_join(all_windows, spi_spr_sites, by="window"), "d.pair.jc", "chr17", "Chromosome 17", expression(atop("spicilegus-spretus")), 1.0, features=inversions)
# 
# spi_spr_rnd_plot = genRFPlot(left_join(all_windows, spi_spr_sites, by="window"), "rnd.jc", "chr17", "Chromosome 17", "spicilegus-spretus\nlog(RND)", "logy", spi_spr_quant, features=inversions)
# 
# #####
# 
# mm_spi_d_plot = genRFPlot(left_join(all_windows, mm_spi_sites, by="window"), "d.pair.jc", "chr17", "Chromosome 17", expression(paste("mm10-spicilegus ", italic("d"))), 1.0, features=inversions)
# 
# mm_spi_rnd_plot = genRFPlot(left_join(all_windows, mm_spi_sites, by="window"), "rnd.jc", "chr17", "Chromosome 17", "mm10-spicilegus\nlog(RND)",  "logy", mm_spi_quant, features=inversions)
# 
# #####
# 
# t_spi_d_plot = genRFPlot(left_join(all_windows, t_spi_sites, by="window"), "d.pair.jc", "chr17", "Chromosome 17", expression(paste("mus-t-spicilegus ", italic("d"))), 1.0, features=inversions)
# 
# t_spi_rnd_plot = genRFPlot(left_join(all_windows, t_spi_sites, by="window"), "rnd.jc", "chr17", "Chromosome 17", "mus-t-spicilegus\nlog(RND)",  "logy", t_spi_quant, features=inversions)
# 
# #####
# 
# p = plot_grid(mm_spi_d_plot, mm_spi_rnd_plot, t_spi_d_plot, t_spi_rnd_plot, cur_rfplot, cur_chromoplot, nrow=6, align="v", rel_heights=c(1,1,1,1,1,2))
# print(p)

```

# Inversion 1

Rolling mean using a sliding window of 5 10kb windows for $d$ and $RND$ (50kb with 10kb step).

```{r inv1, out.width="75%", fig.align = "center", warning=FALSE, fig.height=4}

sites_by_windows = sites_by_windows %>%
  mutate(roll.d.pair.jc = rollapply(d.pair.jc, width=5, FUN=function(x) mean(x, na.rm=TRUE), partial=T, fill=NA, align="left")) %>%
  mutate(roll.rnd.jc = rollapply(rnd.jc, width=5, FUN=function(x) mean(x, na.rm=TRUE), partial=T, fill=NA, align="left"))

#####

cur_chromoplot = genChromoPlot("chr17", "Inversion 1", features=inversions, cur_feature=inversions[1,], num_flank_windows=50, multi_row=F)

#####

cur_rfplot = genRFPlot(dists, "wrf.st", "chr17", "Inversion 1", "wRF to\nspecies tree", ymax=0.5, features=inversions, cur_feature=inversions[1,], num_flank_windows=50)

#####

cur_d_plot = genRFPlot(sites_by_windows, "roll.d.pair.jc", "chr17", "Inversion 1", ymax=1.0, expression(italic("d")[XY]), type="line", groups="label", features=inversions, cur_feature=inversions[1,], num_flank_windows=50)

cur_rnd_plot = genRFPlot(sites_by_windows, "roll.rnd.jc", "chr17", "Inversion 1", "log(RND)", ymax="logy", type="line", groups="label", features=inversions, cur_feature=inversions[1,], num_flank_windows=50)

p_main = plot_grid(cur_d_plot[[1]], cur_rnd_plot[[1]], cur_rfplot[[1]], cur_chromoplot, nrow=4, align="v", rel_heights=c(1,1,1,1,1,2))
#print(p_main)
p = plot_grid(p_main, cur_d_plot[[2]], nrow=2, rel_heights=c(1,0.2))
print(p)

###############

# mm_t_d_plot = genRFPlot(left_join(all_windows, mm_t_sites, by="window"), "d.pair.jc", "chr17", "Inversion 1", expression(paste("mm10-mus-t ", italic("d"))), 1.0, features=inversions, cur_feature=inversions[1,], num_flank_windows=50)
# 
# mm_t_rnd_plot = genRFPlot(left_join(all_windows, mm_t_sites, by="window"), "rnd.jc", "chr17", "Inversion 1", "mm10-mus-t\nlog(RND)",  "logy", mm_t_quant, features=inversions, cur_feature=inversions[1,], num_flank_windows=50)
# 
# #####
# 
# spi_spr_d_plot = genRFPlot(left_join(all_windows, spi_spr_sites, by="window"), "d.pair.jc", "chr17", "Inversion 1", expression(atop("spicilegus-spretus")), 1.0, features=inversions, cur_feature=inversions[1,], num_flank_windows=50)
# 
# spi_spr_rnd_plot = genRFPlot(left_join(all_windows, spi_spr_sites, by="window"), "rnd.jc", "chr17", "Inversion 1", "spicilegus-spretus\nlog(RND)", "logy", spi_spr_quant, features=inversions, cur_feature=inversions[1,], num_flank_windows=50)
# 
# #####
# 
# mm_spi_d_plot = genRFPlot(left_join(all_windows, mm_spi_sites, by="window"), "d.pair.jc", "chr17", "Inversion 1", expression(paste("mm10-spicilegus ", italic("d"))), 1.0, features=inversions, cur_feature=inversions[1,], num_flank_windows=50)
# 
# mm_spi_rnd_plot = genRFPlot(left_join(all_windows, mm_spi_sites, by="window"), "rnd.jc", "chr17", "Inversion 1", "mm10-spicilegus\nlog(RND)",  "logy", mm_spi_quant, features=inversions, cur_feature=inversions[1,], num_flank_windows=50)
# 
# #####
# 
# t_spi_d_plot = genRFPlot(left_join(all_windows, t_spi_sites, by="window"), "d.pair.jc", "chr17", "Inversion 1", expression(paste("mus-t-spicilegus ", italic("d"))), 1.0, features=inversions, cur_feature=inversions[1,], num_flank_windows=50)
# 
# t_spi_rnd_plot = genRFPlot(left_join(all_windows, t_spi_sites, by="window"), "rnd.jc", "chr17", "Inversion 1", "mus-t-spicilegus\nlog(RND)",  "logy", t_spi_quant, features=inversions, cur_feature=inversions[1,], num_flank_windows=50)
# 
# #####
# 
# p = plot_grid(mm_spi_d_plot, mm_spi_rnd_plot, t_spi_d_plot, t_spi_rnd_plot, cur_rfplot, cur_chromoplot, nrow=6, align="v", rel_heights=c(1,1,1,1,1,2))
# print(p)

```

# Inversion 2

Rolling mean using a sliding window of 10 10kb windows for $d$ and $RND$ (100kb with 10kb step).

```{r inv2, out.width="75%", fig.align = "center", warning=FALSE, fig.height=4}

sites_by_windows = sites_by_windows %>%
  mutate(roll.d.pair.jc = rollapply(d.pair.jc, width=10, FUN=function(x) mean(x, na.rm=TRUE), partial=T, fill=NA, align="left")) %>%
  mutate(roll.rnd.jc = rollapply(rnd.jc, width=10, FUN=function(x) mean(x, na.rm=TRUE), partial=T, fill=NA, align="left"))

#####

cur_chromoplot = genChromoPlot("chr17", "Inversion 2", features=inversions, cur_feature=inversions[2,], num_flank_windows=50, multi_row=F)

#####

cur_rfplot = genRFPlot(dists, "wrf.st", "chr17", "Inversion 2", "wRF to\nspecies tree", ymax=0.5, features=inversions, cur_feature=inversions[2,], num_flank_windows=50)

#####

cur_d_plot = genRFPlot(sites_by_windows, "roll.d.pair.jc", "chr17", "Inversion 2", ymax=1.0, expression(italic("d")[XY]), type="line", groups="label", features=inversions, cur_feature=inversions[2,], num_flank_windows=50)

cur_rnd_plot = genRFPlot(sites_by_windows, "roll.rnd.jc", "chr17", "Inversion 2", "log(RND)", type="line", ymax="logy", groups="label", features=inversions, cur_feature=inversions[2,], num_flank_windows=50)

p_main = plot_grid(cur_d_plot[[1]], cur_rnd_plot[[1]], cur_rfplot[[1]], cur_chromoplot, nrow=4, align="v", rel_heights=c(1,1,1,1,1,2))
p = plot_grid(p_main, cur_d_plot[[2]], nrow=2, rel_heights=c(1,0.2))
print(p)

###############

# mm_t_d_plot = genRFPlot(left_join(all_windows, mm_t_sites, by="window"), "d.pair.jc", "chr17", "Inversion 2", expression(paste("mm10-mus-t ", italic("d"))), 1.0, features=inversions, cur_feature=inversions[2,], num_flank_windows=50)
# 
# mm_t_rnd_plot = genRFPlot(left_join(all_windows, mm_t_sites, by="window"), "rnd.jc", "chr17", "Inversion 2", "mm10-mus-t\nlog(RND)",  "logy", mm_t_quant, features=inversions, cur_feature=inversions[2,], num_flank_windows=50)
# 
# #####
# 
# spi_spr_d_plot = genRFPlot(left_join(all_windows, spi_spr_sites, by="window"), "d.pair.jc", "chr17", "Inversion 2", expression(atop("spicilegus-spretus")), 1.0, features=inversions, cur_feature=inversions[2,], num_flank_windows=50)
# 
# spi_spr_rnd_plot = genRFPlot(left_join(all_windows, spi_spr_sites, by="window"), "rnd.jc", "chr17", "Inversion 2", "spicilegus-spretus\nlog(RND)", "logy", spi_spr_quant, features=inversions, cur_feature=inversions[2,], num_flank_windows=50)
# 
# #####
# 
# mm_spi_d_plot = genRFPlot(left_join(all_windows, mm_spi_sites, by="window"), "d.pair.jc", "chr17", "Inversion 2", expression(paste("mm10-spicilegus ", italic("d"))), 1.0, features=inversions, cur_feature=inversions[2,], num_flank_windows=50)
# 
# mm_spi_rnd_plot = genRFPlot(left_join(all_windows, mm_spi_sites, by="window"), "rnd.jc", "chr17", "Inversion 2", "mm10-spicilegus\nlog(RND)",  "logy", mm_spi_quant, features=inversions, cur_feature=inversions[2,], num_flank_windows=50)
# 
# #####
# 
# t_spi_d_plot = genRFPlot(left_join(all_windows, t_spi_sites, by="window"), "d.pair.jc", "chr17", "Inversion 2", expression(paste("mus-t-spicilegus ", italic("d"))), 1.0, features=inversions, cur_feature=inversions[2,], num_flank_windows=50)
# 
# t_spi_rnd_plot = genRFPlot(left_join(all_windows, t_spi_sites, by="window"), "rnd.jc", "chr17", "Inversion 2", "mus-t-spicilegus\nlog(RND)",  "logy", t_spi_quant, features=inversions, cur_feature=inversions[2,], num_flank_windows=50)
# 
# #####
# 
# p = plot_grid(mm_spi_d_plot, mm_spi_rnd_plot, t_spi_d_plot, t_spi_rnd_plot, cur_rfplot, cur_chromoplot, nrow=6, align="v", rel_heights=c(1,1,1,1,1,2))
# print(p)

```

# Inversion 3

Rolling mean using a sliding window of 10 10kb windows for $d$ and $RND$ (100kb with 10kb step).

```{r inv3, out.width="75%", fig.align = "center", warning=FALSE, fig.height=4}

sites_by_windows = sites_by_windows %>%
  mutate(roll.d.pair.jc = rollapply(d.pair.jc, width=10, FUN=function(x) mean(x, na.rm=TRUE), partial=T, fill=NA, align="left")) %>%
  mutate(roll.rnd.jc = rollapply(rnd.jc, width=10, FUN=function(x) mean(x, na.rm=TRUE), partial=T, fill=NA, align="left"))

#####

cur_chromoplot = genChromoPlot("chr17", "Inversion 3", features=inversions, cur_feature=inversions[3,], num_flank_windows=50, multi_row=F)

#####

cur_rfplot = genRFPlot(dists, "wrf.st", "chr17", "Inversion 3", "wRF to\nspecies tree", ymax=0.5, features=inversions, cur_feature=inversions[3,], num_flank_windows=50)

#####

cur_d_plot = genRFPlot(sites_by_windows, "roll.d.pair.jc", "chr17", "Inversion 3", expression(italic("d")[XY]), type="line", groups="label", features=inversions, cur_feature=inversions[3,], num_flank_windows=50)

cur_rnd_plot = genRFPlot(sites_by_windows, "roll.rnd.jc", "chr17", "Inversion 3", "log(RND)", type="line", ymax="logy", groups="label", features=inversions, cur_feature=inversions[3,], num_flank_windows=50)

p_main = plot_grid(cur_d_plot[[1]], cur_rnd_plot[[1]], cur_rfplot[[1]], cur_chromoplot, nrow=4, align="v", rel_heights=c(1,1,1,1,1,2))
p = plot_grid(p_main, cur_d_plot[[2]], nrow=2, rel_heights=c(1,0.2))
print(p)

###############

# mm_t_d_plot = genRFPlot(left_join(all_windows, mm_t_sites, by="window"), "d.pair.jc", "chr17", "Inversion 3", expression(paste("mm10-mus-t ", italic("d"))), 1.0, features=inversions, cur_feature=inversions[3,], num_flank_windows=50)
# 
# mm_t_rnd_plot = genRFPlot(left_join(all_windows, mm_t_sites, by="window"), "rnd.jc", "chr17", "Inversion 3", "mm10-mus-t\nlog(RND)",  "logy", mm_t_quant, features=inversions, cur_feature=inversions[3,], num_flank_windows=50)

#####

# spi_spr_d_plot = genRFPlot(left_join(all_windows, spi_spr_sites, by="window"), "d.pair.jc", "chr17", "Inversion 3", expression(atop("spicilegus-spretus")), 1.0, features=inversions, cur_feature=inversions[3,], num_flank_windows=50)
# 
# spi_spr_rnd_plot = genRFPlot(left_join(all_windows, spi_spr_sites, by="window"), "rnd.jc", "chr17", "Inversion 3", "spicilegus-spretus\nlog(RND)", "logy", spi_spr_quant, features=inversions, cur_feature=inversions[3,], num_flank_windows=50)
# 
# #####
# 
# mm_spi_d_plot = genRFPlot(left_join(all_windows, mm_spi_sites, by="window"), "d.pair.jc", "chr17", "Inversion 3", expression(paste("mm10-spicilegus ", italic("d"))), 1.0, features=inversions, cur_feature=inversions[3,], num_flank_windows=50)
# 
# mm_spi_rnd_plot = genRFPlot(left_join(all_windows, mm_spi_sites, by="window"), "rnd.jc", "chr17", "Inversion 3", "mm10-spicilegus\nlog(RND)",  "logy", mm_spi_quant, features=inversions, cur_feature=inversions[3,], num_flank_windows=50)
# 
# #####
# 
# t_spi_d_plot = genRFPlot(left_join(all_windows, t_spi_sites, by="window"), "d.pair.jc", "chr17", "Inversion 3", expression(paste("mus-t-spicilegus ", italic("d"))), 1.0, features=inversions, cur_feature=inversions[3,], num_flank_windows=50)
# 
# t_spi_rnd_plot = genRFPlot(left_join(all_windows, t_spi_sites, by="window"), "rnd.jc", "chr17", "Inversion 3", "mus-t-spicilegus\nlog(RND)",  "logy", t_spi_quant, features=inversions, cur_feature=inversions[3,], num_flank_windows=50)
# 
# #####
# 
# p = plot_grid(mm_spi_d_plot, mm_spi_rnd_plot, t_spi_d_plot, t_spi_rnd_plot, cur_rfplot, cur_chromoplot, nrow=6, align="v", rel_heights=c(1,1,1,1,1,2))
# print(p)

```

# Inversion 4

Rolling mean using a sliding window of 100 10kb windows for $d$ and $RND$ (1Mb with 10kb step).

```{r inv4, out.width="75%", fig.align = "center", warning=FALSE, fig.height=4}

sites_by_windows = sites_by_windows %>%
  mutate(roll.d.pair.jc = rollapply(d.pair.jc, width=100, FUN=function(x) mean(x, na.rm=TRUE), partial=T, fill=NA, align="left")) %>%
  mutate(roll.rnd.jc = rollapply(rnd.jc, width=100, FUN=function(x) mean(x, na.rm=TRUE), partial=T, fill=NA, align="left"))

#####

cur_chromoplot = genChromoPlot("chr17", "Inversion 4", features=inversions, cur_feature=inversions[4,], num_flank_windows=50, multi_row=F)

#####

cur_rfplot = genRFPlot(dists, "wrf.st", "chr17", "Inversion 4", "wRF to\nspecies tree", ymax=0.5, features=inversions, cur_feature=inversions[4,], num_flank_windows=50)

#####

cur_d_plot = genRFPlot(sites_by_windows, "roll.d.pair.jc", "chr17", "Inversion 4", ymax=1.0, expression(italic("d")[XY]), type="line", groups="label", features=inversions, cur_feature=inversions[4,], num_flank_windows=50)

cur_rnd_plot = genRFPlot(sites_by_windows, "roll.rnd.jc", "chr17", "Inversion 4", "log(RND)", type="line", ymax="logy", groups="label", features=inversions, cur_feature=inversions[4,], num_flank_windows=50)

p_main = plot_grid(cur_d_plot[[1]], cur_rnd_plot[[1]], cur_rfplot[[1]], cur_chromoplot, nrow=4, align="v", rel_heights=c(1,1,1,1,1,2))
p = plot_grid(p_main, cur_d_plot[[2]], nrow=2, rel_heights=c(1,0.2))
print(p)

###############

# mm_t_d_plot = genRFPlot(left_join(all_windows, mm_t_sites, by="window"), "d.pair.jc", "chr17", "Inversion 4", expression(paste("mm10-mus-t ", italic("d"))), 1.0, features=inversions, cur_feature=inversions[4,], num_flank_windows=50)
# 
# mm_t_rnd_plot = genRFPlot(left_join(all_windows, mm_t_sites, by="window"), "rnd.jc", "chr17", "Inversion 4", "mm10-mus-t\nlog(RND)",  "logy", mm_t_quant, features=inversions, cur_feature=inversions[4,], num_flank_windows=50)
# 
# #####
# 
# spi_spr_d_plot = genRFPlot(left_join(all_windows, spi_spr_sites, by="window"), "d.pair.jc", "chr17", "Inversion 4", expression(atop("spicilegus-spretus")), 1.0, features=inversions, cur_feature=inversions[4,], num_flank_windows=50)
# 
# spi_spr_rnd_plot = genRFPlot(left_join(all_windows, spi_spr_sites, by="window"), "rnd.jc", "chr17", "Inversion 4", "spicilegus-spretus\nlog(RND)", "logy", spi_spr_quant, features=inversions, cur_feature=inversions[4,], num_flank_windows=50)
# 
# #####
# 
# mm_spi_d_plot = genRFPlot(left_join(all_windows, mm_spi_sites, by="window"), "d.pair.jc", "chr17", "Inversion 4", expression(paste("mm10-spicilegus ", italic("d"))), 1.0, features=inversions, cur_feature=inversions[4,], num_flank_windows=50)
# 
# mm_spi_rnd_plot = genRFPlot(left_join(all_windows, mm_spi_sites, by="window"), "rnd.jc", "chr17", "Inversion 4", "mm10-spicilegus\nlog(RND)",  "logy", mm_spi_quant, features=inversions, cur_feature=inversions[4,], num_flank_windows=50)
# 
# #####
# 
# t_spi_d_plot = genRFPlot(left_join(all_windows, t_spi_sites, by="window"), "d.pair.jc", "chr17", "Inversion 4", expression(paste("mus-t-spicilegus ", italic("d"))), 1.0, features=inversions, cur_feature=inversions[4,], num_flank_windows=50)
# 
# t_spi_rnd_plot = genRFPlot(left_join(all_windows, t_spi_sites, by="window"), "rnd.jc", "chr17", "Inversion 4", "mus-t-spicilegus\nlog(RND)",  "logy", t_spi_quant, features=inversions, cur_feature=inversions[4,], num_flank_windows=50)
# 
# #####
# 
# p = plot_grid(mm_spi_d_plot, mm_spi_rnd_plot, t_spi_d_plot, t_spi_rnd_plot, cur_rfplot, cur_chromoplot, nrow=6, align="v", rel_heights=c(1,1,1,1,1,2))
# print(p)

```

# Baseline comparisons to non-inversion windows

```{r non-inv-comps, warning=FALSE, results='asis'}

pairs = unique(sites_by_windows$label)
x_comps = list(c("inv01", "Non-inversion"), c("inv02", "Non-inversion"), c("inv03", "Non-inversion"), c("inv04", "Non-inversion"))
sig_comp_lvls = c("Non-inversion-inv01", "Non-inversion-inv02", "Non-inversion-inv03", "Non-inversion-inv04")

sig_cols = c("N.S."="#333333", 
             "*"=corecol(pal="wilke", numcol=1, offset=4), 
             "**"=corecol(pal="wilke", numcol=1, offset=2), 
             "***"=corecol(pal="wilke", numcol=1, offset=6))

for(pair in pairs){
  
  cat(paste0("## ", pair, "\n"))
  
  cur_data = sites_by_windows %>% 
    filter(label == pair) %>%
    mutate(inv.overlap = replace_na(inv.overlap, "Non-inversion"))
  
  d_plot = cur_data %>%
    filter(d.out.jc < 1) %>%
    ggplot(aes(x=inv.overlap, y=d.out.jc)) +
    geom_quasirandom(size=2, width=0.25, alpha=0.25) +
    geom_signif(comparisons=x_comps, map_signif_level=TRUE, textsize=4, size=1, step_increase=0.12, margin_top=0.1) +
    #geom_point() +
    geom_boxplot(outlier.shape=NA) +
    xlab("") +
    ylab(expression(italic("d"))) + 
    bartheme() + 
    theme(axis.text.x = element_text(angle=25, hjust=1))
  #print(d_plot)
  
  rnd_plot = cur_data %>%
    #filter(d.out.jc < 1) %>%
    ggplot(aes(x=inv.overlap, y=rnd.jc.log)) +
    geom_quasirandom(size=2, width=0.25, alpha=0.25) +
    geom_signif(comparisons=x_comps, map_signif_level=TRUE, textsize=4, size=1, step_increase=0.12, margin_top=0.1) +
    #geom_point() +
    geom_boxplot(outlier.shape=NA) +
    xlab("") +
    ylab("RND") + 
    bartheme() + 
    theme(axis.text.x = element_text(angle=25, hjust=1))
  #print(rnd_plot)
  
  title <- ggdraw() + draw_label(pair)
  
  p1 = plot_grid(d_plot, rnd_plot, nrow=1, ncol=2)
  p = plot_grid(title, p1, nrow=2, rel_heights=c(0.1, 1))
  print(p)
  
  ## Plot distributions of d and RND for each inversion and non-inversion windows
  ##########
  
  anova_data = cur_data %>%
    drop_na(d.out.jc) %>%
    filter(d.out.jc < 1)
  # Get rid of the NAs and filter values higher than 1
  
  d_anova = aov(d.out.jc ~ inv.overlap, data=anova_data)
  d_anova_res = residuals(d_anova)
  d_anova_res_sample = sample(d_anova_res, 5000)
  d_anova_shapiro = shapiro.test(d_anova_res_sample)
  # Do the ANOVA and check the distribution of the residuals
  
  #qqnorm(d_anova_res)
  #qqline(d_anova_res)
  
  cat("\n\n<details><summary>Click to reveal stats</summary>\n")
  
  d_anova_qqplot = ggqqplot(d_anova_res) +
    ggtitle(paste(pair, " - QQ Plot of Residuals")) +
    xlab("Theoretical Quantiles") +
    ylab("Sample Quantiles") +
    annotate("text", x = 2, y = 2, label = paste("Shapiro p-value =", round(d_anova_shapiro$p.value, digits = 3)))
  print(d_anova_qqplot)
  # Plot a qqplot to visualize
  
  cat(paste("```Shapiro p-value (null: ANOVA residuals are normally distributed): ", round(d_anova_shapiro$p.value, digits = 3), "```\n"))
  
  d_levene = leveneTest(anova_data$d.out.jc, anova_data$inv.overlap, center=mean)
  cat(paste("```Levene p-value (null: variances among the groups are the same): ", round(d_levene[1, "Pr(>F)"]), "```\n"))
  # Check if for homoscedasticity between pairs of distributions
  
  cat("```Since data are not normal or homosecdastic, we don't do ANOVA.```\n")
  
  ## Check if data are normal and have homoscedasticity for an ANOVA (they aren't)
  ##########
  
  kruskal_data = cur_data %>% 
    drop_na(d.out.jc) %>%
    filter(d.out.jc < 1)
  
  d_kw = kruskal.test(d.out.jc ~ inv.overlap, data=kruskal_data)
  cat(paste("```Kruskal p-value (null: groups are the same): ", round(d_kw$p.value, digits = 3), "```\n"))
  # Perform the Kruskal test as a non-parametric alternative to ANOVA
  # to determine if groups are the same (null)
  
  cat("\n</details>")
  
  # d_dunn = dunnTest(d.out.jc ~ inv.overlap, data=kruskal_data, method="bonferroni")
  # d_dunn_df = as.data.frame(d_dunn$res)
  # # Dunn test for pairwise differences
  
  ##########

  inv_groups = unique(kruskal_data$inv.overlap)
  # Get the list of inversion groups
  
  pairwise_results = data.frame()
  # Initialize a data frame to store the results
  
  for (i in 1:(length(inv_groups) - 1)) {
    for (j in (i + 1):length(inv_groups)) {
      # Loop over each pair of groups
      
      if(inv_groups[i] == "Non-inversion" || inv_groups[j] == "Non-inversion") {
        group1_data <- kruskal_data$d.out.jc[kruskal_data$inv.overlap == inv_groups[i]]
        group2_data <- kruskal_data$d.out.jc[kruskal_data$inv.overlap == inv_groups[j]]
        # Subset the data for the two groups
        
        wilcox_result <- wilcox.test(group1_data, group2_data, conf.int = TRUE)
        # Perform the Wilcox test
  
        pairwise_results <- rbind(pairwise_results, data.frame(
          Group1 = inv_groups[i],
          Group2 = inv_groups[j],
          MedianDifference = wilcox_result$estimate,
          ConfLow = wilcox_result$conf.int[1],
          ConfHigh = wilcox_result$conf.int[2],
          wilcox.p = wilcox_result$p.value
        ))
        # Store the results
      }
    }
  }
  
  #print(pairwise_results)
  # Print the results
  
  pairwise_results$sig = "N.S."
  pairwise_results[pairwise_results$wilcox.p <= 0.05,]$sig = "*"
  pairwise_results[pairwise_results$wilcox.p <= 0.01,]$sig = "**"
  pairwise_results[pairwise_results$wilcox.p <= 0.001,]$sig = "***"
  # # Add a significance label column 
  
  
  pairwise_results$GroupComparison = with(pairwise_results, paste(Group1, Group2, sep = " - "))
  pairwise_results$GroupComparison = with(pairwise_results, reorder(GroupComparison, GroupComparison))
  # Reorder the results alphabetically
  
  #pairwise_results$GroupComparison = with(pairwise_results, reorder(interaction(Group1, Group2), MedianDifference))
  # Reorder the results by the estimator
  
  # Plot the median differences with confidence intervals, colored by significance level
  pairwise_p = ggplot(pairwise_results, aes(x=GroupComparison, y=MedianDifference, color=sig)) +
    geom_point() +
    geom_errorbar(aes(ymin=ConfLow, ymax=ConfHigh), width=0.2) +
    geom_hline(yintercept=0, size=1, linetype=2) +
    scale_color_manual(values=sig_cols, limits=names(sig_cols), drop=FALSE) +
    ggtitle(paste(pair, "- shifts in d")) +
    #xlab("Group Comparison") +
    ylab("Estimated Shift in d") +
    bartheme() +
    theme(panel.grid.major.x=element_line(color="#d3d3d3", size=0.5, linetype=1),
          panel.grid.major.y=element_line(color="#d3d3d3", size=0.5, linetype=1),
          plot.title = element_text(size=14, margin=margin(b=20)),
          axis.text.x=element_text(angle=40, hjust=1, size=10),
          axis.title.y=element_text(size=12),
          plot.margin=margin(0.5,0.5,0,0.5, unit="cm")) +    
    coord_flip()

  print(pairwise_p)

  cat("\n")
  cat("\n\n---\n\n")
}

```



```{r test, warning=FALSE, eval=F}

##########
  ## Dunn test plotting code (small conf. intervals)
  # Plot the differences with bootstrapped confidence intervals
  # d_dunn_plot = ggplot(d_dunn_df, aes(x=reorder(Comparison, Z), y=Z)) +
  #   geom_point() +
  #   geom_errorbar(aes(ymin=boot_conf.low, ymax=boot_conf.high), width=0.4) +
  #   coord_flip() +
  #   xlab("Comparison") +
  #   ylab("Difference") +
  #   theme_bw()
  # print(d_dunn_plot)
  # 
  # # Add lower and upper confidence limits based on Z values
  # d_dunn_df$conf.low <- d_dunn_df$Z - qnorm(0.975) * sqrt(1/(length(cur_data$d.out.jc)))
  # d_dunn_df$conf.high <- d_dunn_df$Z + qnorm(0.975) * sqrt(1/(length(cur_data$d.out.jc)))
  # 
  # d_dunn_df$sig = "N.S."
  # d_dunn_df[d_dunn_df$P.adj <= 0.05,]$sig = "*"
  # d_dunn_df[d_dunn_df$P.adj <= 0.01,]$sig = "**"
  # d_dunn_df[d_dunn_df$P.adj <= 0.001,]$sig = "***"
  # # Add a significance label column
  # 
  # # Plot the differences with confidence intervals
  # d_dunn_plot = ggplot(d_dunn_df, aes(x=reorder(Comparison, Z), y=Z, color=sig)) +
  #   geom_point() +
  #   geom_errorbar(aes(ymin=conf.low, ymax=conf.high), width=0.4) +
  #   coord_flip() +
  #   xlab("Comparison") +
  #   ylab("Difference") +
  #   theme_bw()
  # print
  ## Dunn test plotting code (small conf. intervals)
  ##########

  ##########
  ## ANOVA plotting code
  
  # d_anova_comp = TukeyHSD(d_anova)
  # # Perform ANOVA and Tukey mean difference test on results
  # 
  # d_anova_comp = as.data.frame(d_anova_comp[1])
  # d_anova_comp$comp = row.names(d_anova_comp)
  # # Convert Tukey results to df
  # 
  # d_anova_comp$sig = "N.S."
  # d_anova_comp[d_anova_comp$inv.overlap.p.adj <= 0.05,]$sig = "*"
  # d_anova_comp[d_anova_comp$inv.overlap.p.adj <= 0.01,]$sig = "**"
  # d_anova_comp[d_anova_comp$inv.overlap.p.adj <= 0.001,]$sig = "***"
  # # Add a significance label column
  # 
  # #d_anova_comp$comp = factor(d_anova_comp$comp, levels=sig_comp_lvls)
  # # Re-order the comparisons by factoring with pre-ordered levels
  # 
  # d_anova_plot = ggplot(d_anova_comp, aes(x=comp, y=inv.overlap.diff, color=sig)) +
  #   geom_point(size=3) +
  #   geom_errorbar(aes(ymin=inv.overlap.lwr, ymax=inv.overlap.upr), width=0.25, size=1) +
  #   geom_hline(yintercept=0, size=1, linetype=2) +
  #   scale_color_manual(values=sig_cols, drop=FALSE) +
  #   #xlab("Feature window comparison\nof wRF to species tree") +
  #   xlab("") +
  #   ylab("Difference in means") +
  #   bartheme() +
  #   theme(panel.grid.major.x=element_line(color = "#d3d3d3", size=0.5, linetype=1),
  #         axis.text.x=element_text(angle=40, hjust=1, size=10),
  #         axis.title.y=element_text(size=12),
  #         plot.margin=margin(0.5,0.5,0,0.5, unit="cm"))
  #   #coord_flip()
  # print(d_anova_plot)
  # # Plot the differences in spec wrf, colored by significance level
  ## ANOVA plotting code
  ##########

set.seed(123) # set seed for reproducibility
random_data <- data.frame(row_number = 1:100000, random_values = runif(100000, min = 0, max = 1))
names(random_data) = c("row", "value")

random_subset = random_data %>% 
  filter(row > 10000 & row < 11000) %>%
  mutate(value = rollapply(value, width=999, FUN=function(x) mean(x, na.rm=TRUE), partial=TRUE, fill=NA, align="left"))

random_data = random_data %>%
  mutate(value = rollapply(value, width=999, FUN=function(x) mean(x, na.rm=TRUE), partial=TRUE, fill=NA, align="left")) %>%
  filter(row > 10000 & row < 11000)



p = ggplot(random_data, aes(x=row, y=value)) +
  geom_line(color="#920000") +
  #geom_line(data=random_subset, aes(x=row, y=value), color="blue") +
  bartheme()

print(p)

p = ggplot(random_subset, aes(x=row, y=value)) +
  geom_line(color="blue") +
  #geom_line(data=random_subset, aes(x=row, y=value), color="blue") +
  bartheme()
print(p)



df = data.frame(row = 1:10, val = c(1,2,3,4,5,6,7,8,9,10))

df = df %>% 
  mutate(center = rollapply(val, width=2, FUN=function(x) mean(x, na.rm=TRUE), partial=TRUE, fill=NA, align="center")) %>%
  mutate(left = rollapply(val, width=2, FUN=function(x) mean(x, na.rm=TRUE), partial=TRUE, fill=NA, align="left")) %>%
  mutate(right = rollapply(val, width=2, FUN=function(x) mean(x, na.rm=TRUE), partial=TRUE, fill=NA, align="right"))
print(df)

df_subset = df %>% 
  filter(val>3 & val <8) %>%
  mutate(center = rollapply(val, width=2, FUN=function(x) mean(x, na.rm=TRUE), partial=TRUE, fill=NA, align="center")) %>%
  mutate(left = rollapply(val, width=2, FUN=function(x) mean(x, na.rm=TRUE), partial=TRUE, fill=NA, align="left")) %>%
  mutate(right = rollapply(val, width=2, FUN=function(x) mean(x, na.rm=TRUE), partial=TRUE, fill=NA, align="right"))
print(df_subset)
```































